<!DOCTYPE html>
<html>
  <head>
    <title>Canada Trip Planner</title>
    <link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css" type="text/css">
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://openlayers.org/en/v4.6.5/build/ol-debug.js"></script>

    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/css/materialize.min.css">

    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/js/materialize.min.js"></script>
       

    <!-- Custom JS & CSS -->
    <script src="./editor.js"></script>
  </head>
  <body>
    <div id="map" class="map"></div>
    <button id="export_kml" onclick="exportKml()">Export Route</button>
    <ul id="route_placemarks"></ul>
    <script>

      /********************************************
                    INITIALIZATION
      ********************************************/
      // Base Layer
      var bing = new ol.layer.Tile({
        visible: true,
        preload: Infinity,
        source: new ol.source.BingMaps({
          key: 'AlWoguuHB5fubEl4l0x602tHSMOJJY0spFDE_qrlL8iXTzBbQb1o-wPlImvDW6Gf',
          imagerySet: 'Road', // 'Road', 'RoadOnDemand', 'Aerial', 'AerialWithLabels', 'collinsBart', 'ordnanceSurvey'
          maxZoom: 19
        })
      })

      // Route Layer (edit mode = can draw)
      var drawing_source = new ol.source.Vector({
        url: 'http://localhost:8080/route.kml',
        format: new ol.format.KML({extractStyles:false, writeStyles:false}),
      });
      var drawing_route = new ol.layer.Vector({ 
        source: drawing_source,
        style: routePlacemarkStyleFunction
      });

      // Automatic route drawing : takes all the points and binds them together
      var auto_route = new ol.layer.Vector({ 
        source: new ol.source.Vector(),
        style: routeLineStyleFunction
      });

      var map = new ol.Map({
        target: 'map',
        layers: [bing, drawing_route, auto_route],
        view: new ol.View({
          center: [-11000000, 7800000],
          zoom: 4
        })
      });

      // Drawing controls
      var modify = new ol.interaction.Modify({source: drawing_source});
      var draw = new ol.interaction.Draw({ source: drawing_source, type: 'Point' });
      var snap = new ol.interaction.Snap({source: drawing_source});
      map.addInteraction(modify);
      map.addInteraction(draw);
      map.addInteraction(snap);

      // Listeners
      drawing_source.on('change', fill_auto_route_layer_and_route_list)

      /********************************************
                  OPENLAYERS CONNECTORS
      ********************************************/
      function update_route_list() {
        fill_route_list(drawing_source.getFeatures().sort(featureSortingFunction))
      }

      function update_drawing_layer() {
        drawing_source.refresh()
      }

      function fill_auto_route_layer_and_route_list() {
        update_route_list()
        fill_auto_route_layer()
      }

      function exportKml() {
        console.log(new ol.format.KML({extractStyles:false, writeStyles:true}).writeFeatures(drawing_source.getFeatures().sort(featureSortingFunction), {featureProjection: "EPSG:3857", dataProjection: "EPSG:4326", decimals:2}))
      }

    </script>
  </body>
</html>